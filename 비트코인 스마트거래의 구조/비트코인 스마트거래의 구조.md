## 제6강 비트코인 스마트거래의 구조

- 비트코인 거래가 어떻게 작성되는지에 대해 스마트 거래 관점에서 설명



- ##### 비트코인 거래의 개념	

  - 비트코인 거래(transaction)
    - 참여자들이 비트코인 통화 등 가치를 주고받고 상호 인정하는 행위를 규정하는 데이터 구조
    - 블록체인에 공개적으로 투명하게 저장되는 항목
    - 중요 데이터(문서) 저장 거래도 가능
  - 비트코인 지불 거래(payment transaction)
    - 블록체인상에서 입력값으로 표현되는 자금원으로부터 출력값으로 표현되는 목적지까지 자금을 전달하는 행위를 규정
  - 일반적인 지불 거래
    - 입력값은 자신이 소유권을 가지고 있는 이전 거래의 출력값중에 아직 소비되지않은 출력값(UTXO)을 해시 포인터로 참조함으로써 설정
    - UTXO의 소유권은 해당 주소에 대응되는 개인키로 작성된 서명을 거래의 입력값에 포함시킴으로써 증명
    - 특정 거래에서 한번 설정된 입력값은 반드시 해당 거래에서 전부 소비 - 지금 정보가 노출되는 프라이버시 문제 방지
    - 거래 검증을 수행하는 참여자들은 UTXO의 신속한 검색을 위해 블록체인 상의 전체 UTXO들을 하드 디스크가 아닌 RAM 메모리 풀로 유지
  - 거래 수수료
    - 거래가 처리하는 자금의 크기가 아니라 거래의 데이터 크기에 다라 계산
    - 킬로 바이트에 대한 단위 거래 수수료가 먼저 설정되고, 여기에 킬로바이트 단위의 거래 크기가 곱해져 거래 수수료로 계산
    - 단위 수수료 설정 : 시장에서 설정
    - 거래 수수료 표시 = 입력값 총합 - 출력값 총합
    - 자금 합산 거래
    - 지급 분산 거래

- ##### 거래 자료 구조

| 크기(바이트) | 필드        | 설명                                        |
| ------------ | ----------- | ------------------------------------------- |
| 4            | 버전        | 거래가  프로토콜 버전                       |
| 1~9          | 입력값 개수 | 거래에 포함된 입력값의 개수                 |
| 가변         | 입력값      | 거래가 소비할 입력값(개수만큼 반복)         |
| 1~9          | 출력값 개수 | 거래에 포함된 출력값의 개수                 |
| 가변         | 출력값      | 거래가 생성할 출력값(개수만큼 반복)         |
| 4            | 잠금시간    | 정해진 시점까지 거래 채굴을 연기하도록 명시 |

- ##### 거래 자료 구조

  - 코인 베이스 거래
    - 채굴자에게 네트워크가 자동으로 신규 비트코인을 지불하는 거래 
  - 잠금 스크립트(locking script)
    - 해당 출력값을 소비하기 위해 충족시켜야 하는 조건을 기술한 간단한 실행 프로그램
    - ex) scriptPubKey = DUP HAS160 <PubKHash> EQUALVERIFY CHECKSIG
  - 해제 스크립트 
    - 서명과 공개키를 데이터로 제공
    - scriptSig = <sig><pubK>

- 거래 스크립트 언어

  - 스택
    - 입력되는 데이터의 순서와 반대의 순서로 서로 입력된 데이터가 출력되는 자료 구조
    - 푸시 : 스택 자료 구조에 데이터를 입력
    - 팝 : 입력된 데이터를 출력하는 동작
  - 비트코인 스택 언어
    - 스택 자료 구조에 데이터를 입출력하면서 프로그램에 기술된 각 명령을 순서대로 한번씩만 수행하는 제한적인 기능의 단순한 언어
    - 일련의 명령들을 반복해서 수행하는 루프명령 미지원
    - 튜링 불완전(Turing-incomplete) 언어 루프기능을 제외한 프로그래밍 언어로써 불완전한 언어
    - 풀 노드들이 거래를 검증할 때 지나치게 많은 시간이 소요되어 비트코인 네트워크의 성능이 낮아지는 것을 방지 -> DoS 공격 방어 
  - 비트코인 스크립트 언어의 주요 명령어

  ```
  <data>
  OP_DUP
  OP_HASH160
  OP_EQUALVERIFY
  OP_CHECKSIG
  OP_CHECKMULTISIG
  ```

- ##### 비트코인 거래

  - 거래 조건을 프로그램으로 결정

  - 프로그램 실행을 통해 거래 정지 여부 결정

  - 다양한 유형의 스마트 거래 개발 가능

  - ##### 그러나

  - 튜링 불완전(Turing-incomplete) 언어인 비트코인 스크립트 언어의 프로그래밍 능력에 한계

  - 복잡한 스마트 거래 유형 개발에 어려움